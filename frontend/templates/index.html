<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run GitHub Action</title>
    <link rel="icon" type="image/jpeg" href="/static/fav.jpeg">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        {% if not user %}
        <div class="auth-overlay">
            <div class="auth-modal">
                <h2>Authentication Required</h2>
                <p>Please sign in with GitHub to run workflows</p>
                <a href="/auth/github" class="btn btn-primary">Sign in with GitHub</a>
            </div>
        </div>
        {% endif %}

        <header>
            <h1>Run GitHub Action</h1>
            <div class="logo-container">
                <img src="/static/fav.jpeg" alt="GitHub Action" class="github-logo">
            </div>
        </header>

        {% if user %}
        <main>
            <form id="workflowForm" action="/workflow/trigger" method="post" class="workflow-form">
                <div class="form-group">
                    <div class="field-header">
                        <label for="repository">Repository</label>
                    </div>
                    <div class="searchable-select-wrapper">
                        <input type="text" 
                               id="repository" 
                               class="searchable-select-input" 
                               placeholder="owner/repo"
                               value="{% if default_owner and default_repo %}{{ default_owner }}/{{ default_repo }}{% endif %}"
                               required>
                        <select id="repository_select" class="searchable-select" style="display: none;">
                            <option value=""></option>
                        </select>
                        <div class="searchable-select-dropdown" id="repository_dropdown"></div>
                    </div>
                    <input type="hidden" id="owner" name="owner" value="{{ default_owner or '' }}">
                    <input type="hidden" id="repo" name="repo" value="{{ default_repo or '' }}">
                </div>
                
                <div class="form-group">
                    <div class="field-header">
                        <label for="branch">Branch</label>
                    </div>
                    <div class="field-with-loader">
                        <div class="searchable-select-wrapper">
                            <input type="text" 
                                   id="branch_search" 
                                   class="searchable-select-input" 
                                   placeholder="main"
                                   value="{% if branches and branches|length > 0 %}main{% else %}main{% endif %}">
                            <select id="ref" name="ref" class="searchable-select">
                                {% if branches and branches|length > 0 %}
                                    {% for branch in branches %}
                                        <option value="{{ branch }}" {% if branch == 'main' %}selected{% endif %}>{{ branch }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="main" selected>main</option>
                                {% endif %}
                            </select>
                            <div class="searchable-select-dropdown" id="branch_dropdown"></div>
                        </div>
                        <div id="branch-loader" class="field-loader" style="display: none;">
                            <div class="spinner-small"></div>
                        </div>
                    </div>
                    <div id="branch-error" class="error-state" style="display: none; margin-top: 8px;"></div>
                </div>
                
                <div class="form-group">
                    <div class="field-header">
                        <label for="workflow_id">Workflow</label>
                        <span class="optional">Optional</span>
                    </div>
                    <div class="field-with-loader">
                        <div class="searchable-select-wrapper">
                            <input type="text" 
                                   id="workflow_search" 
                                   class="searchable-select-input" 
                                   placeholder="build - Build project"
                                   value="{% if default_workflow_id %}{{ default_workflow_id }}{% endif %}">
                            <select id="workflow_id" name="workflow_id" class="searchable-select">
                                {% if workflows and workflows|length > 0 %}
                                    {% for workflow in workflows %}
                                        <option value="{{ workflow.id }}" 
                                                data-name="{{ workflow.name }}"
                                                {% if workflow.id == default_workflow_id %}selected{% endif %}>
                                            {{ workflow.id }} - {{ workflow.name }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="{{ default_workflow_id or '' }}" selected>{{ default_workflow_id or '' }}</option>
                                {% endif %}
                            </select>
                            <div class="searchable-select-dropdown" id="workflow_dropdown"></div>
                        </div>
                        <div id="workflow-loader" class="field-loader" style="display: none;">
                            <div class="spinner-small"></div>
                        </div>
                    </div>
                    <div id="workflow-error" class="error-state" style="display: none; margin-top: 8px;"></div>
                </div>

                {# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –¥–ª—è workflow inputs #}
                <div id="workflow-inputs-wrapper" style="display: none;">
                    <div id="workflow-inputs"></div>
                </div>
                
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Run workflow</button>
                    <button type="button" id="copy-run-btn" class="btn btn-secondary" style="flex: 0 0 auto; opacity: 0.6; font-size: 13px; padding: 8px 16px; border-color: #d1d5db; background: #f9fafb; color: #6b7280;">Copy run</button>
                </div>
            </form>
            
            <footer class="page-footer">
                <div class="footer-content">
                    <div class="user-info">
                        {% if user.avatar_url %}
                        <img src="{{ user.avatar_url }}" alt="{{ user.login }}" class="user-avatar">
                        {% else %}
                        <div class="user-icon">üë§</div>
                        {% endif %}
                        <span class="user-login">{{ user.login }}</span>
                    </div>
                    <a href="/auth/logout" class="btn btn-secondary btn-small">–í—ã–π—Ç–∏</a>
                </div>
            </footer>
        </main>
        {% endif %}
    </div>
    
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ searchable select
        function initSearchableSelect(searchInputId, selectId, dropdownId) {
            const searchInput = document.getElementById(searchInputId);
            const select = document.getElementById(selectId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!searchInput || !select || !dropdown) return;
            
            function updateDropdown() {
                dropdown.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                
                Array.from(select.options).forEach(function(option) {
                    if (option.value === '') return;
                    
                    const text = option.textContent.toLowerCase();
                    const matches = searchTerm === '' || text.includes(searchTerm);
                    
                    const div = document.createElement('div');
                    div.className = 'searchable-select-option' + (matches ? '' : ' hidden');
                    if (option.selected) {
                        div.classList.add('selected');
                    }
                    div.textContent = option.textContent;
                    div.addEventListener('click', function() {
                        select.value = option.value;
                        searchInput.value = option.textContent;
                        dropdown.classList.remove('show');
                        updateDropdown();
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º workflow inputs –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ workflow
                        if (selectId === 'workflow_id') {
                            loadWorkflowInputs();
                        }
                    });
                    dropdown.appendChild(div);
                });
            }
            
            searchInput.addEventListener('focus', function() {
                updateDropdown();
                dropdown.classList.add('show');
            });
            
            searchInput.addEventListener('input', function() {
                updateDropdown();
                dropdown.classList.add('show');
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–ø—Ü–∏–µ–π - –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    Array.from(select.options).forEach(function(option) {
                        if (option.value === '' || option.value === searchTerm || option.textContent.toLowerCase() === searchTerm.toLowerCase()) {
                            if (option.value === searchTerm || option.textContent.toLowerCase() === searchTerm.toLowerCase()) {
                                select.value = option.value;
                                return;
                            }
                        }
                    });
                }
            });
            
            // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–ø—Ü–∏–µ–π - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            searchInput.addEventListener('blur', function() {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ –æ–ø—Ü–∏–∏ —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å
                setTimeout(function() {
                    const searchTerm = searchInput.value.trim();
                    const selectedOption = select.options[select.selectedIndex];
                    
                    // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–µ–π, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    if (searchTerm && selectedOption && selectedOption.textContent.toLowerCase() !== searchTerm.toLowerCase()) {
                        let found = false;
                        Array.from(select.options).forEach(function(option) {
                            if (option.value && !found) {
                                if (option.textContent.toLowerCase() === searchTerm.toLowerCase() || 
                                    option.value.toLowerCase() === searchTerm.toLowerCase()) {
                                    select.value = option.value;
                                    searchInput.value = option.textContent;
                                    found = true;
                                }
                            }
                        });
                        
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        if (!found && selectedOption && selectedOption.value) {
                            searchInput.value = selectedOption.textContent;
                        }
                    } else if (selectedOption && selectedOption.value) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
                        searchInput.value = selectedOption.textContent;
                    }
                    
                    dropdown.classList.remove('show');
                }, 200);
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target) && !select.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
            
            select.addEventListener('change', function() {
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption) {
                    searchInput.value = selectedOption.textContent;
                }
                if (selectId === 'workflow_id') {
                    loadWorkflowInputs();
                } else if (selectId === 'ref') {
                    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ branch –∑–∞–≥—Ä—É–∂–∞–µ–º workflows
                    const ownerInput = document.getElementById('owner');
                    const repoInput = document.getElementById('repo');
                    if (ownerInput && repoInput) {
                        const owner = ownerInput.value.trim();
                        const repo = repoInput.value.trim();
                        if (owner && repo) {
                            loadWorkflows(owner, repo);
                        }
                    }
                }
            });
            
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption) {
                searchInput.value = selectedOption.textContent;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ workflow inputs
        async function loadWorkflowInputs() {
            const owner = document.getElementById('owner').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const workflowId = document.getElementById('workflow_id').value.trim();
            const inputsContainer = document.getElementById('workflow-inputs');
            const inputsWrapper = document.getElementById('workflow-inputs-wrapper');
            
            if (!owner || !repo || !workflowId || !inputsContainer || !inputsWrapper) {
                inputsContainer.innerHTML = '';
                inputsWrapper.style.display = 'none';
                return;
            }
            
            try {
                inputsWrapper.style.display = 'block';
                inputsContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>Loading workflow parameters...</span></div>';
                
                const response = await fetch(`/api/workflow-info?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}&workflow_id=${encodeURIComponent(workflowId)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const inputs = data.inputs || {};
                    
                    if (Object.keys(inputs).length === 0) {
                        inputsContainer.innerHTML = '';
                        inputsWrapper.style.display = 'none';
                        return;
                    }
                    
                    let html = '';
                    for (const [inputName, inputConfig] of Object.entries(inputs)) {
                        const isRequired = inputConfig.required || false;
                        const defaultValue = inputConfig.default;
                        const description = inputConfig.description || '';
                        
                        html += '<div class="form-group">';
                        html += `<div class="field-header">`;
                        html += `<label for="input_${inputName}">${inputName}</label>`;
                        if (!isRequired) {
                            html += `<span class="optional">Optional</span>`;
                        }
                        html += `</div>`;
                        
                        if (inputConfig.type === 'choice') {
                            html += `<select id="input_${inputName}" name="${inputName}" class="form-select" ${isRequired ? 'required' : ''}>`;
                            if (!isRequired) {
                                html += '<option value=""></option>';
                            }
                            for (const option of inputConfig.options || []) {
                                html += `<option value="${option}" ${option === defaultValue ? 'selected' : ''}>${option}</option>`;
                            }
                            html += '</select>';
                        } else if (inputConfig.type === 'boolean') {
                            html += `<div class="checkbox-wrapper">`;
                            html += `<label class="checkbox-label">`;
                            html += `<input type="checkbox" id="input_${inputName}" name="${inputName}" value="true" ${defaultValue ? 'checked' : ''}>`;
                            html += `<span>${inputName}</span>`;
                            html += `</label>`;
                            html += `</div>`;
                        } else if (inputConfig.type === 'environment') {
                            html += `<select id="input_${inputName}" name="${inputName}" class="form-select" ${isRequired ? 'required' : ''}>`;
                            if (!isRequired) {
                                html += '<option value=""></option>';
                            }
                            for (const env of ['production', 'staging', 'development', 'test']) {
                                html += `<option value="${env}" ${env === defaultValue ? 'selected' : ''}>${env}</option>`;
                            }
                            html += '</select>';
                        } else {
                            html += `<input type="text" id="input_${inputName}" name="${inputName}" value="${defaultValue || ''}" placeholder="" class="form-input" ${isRequired ? 'required' : ''}>`;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º description —Å–µ—Ä—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø–æ–¥ –ø–æ–ª–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (description) {
                            html += `<small style="color: #9ca3af; font-size: 12px; margin-top: 4px; display: block;">${description}</small>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    inputsContainer.innerHTML = html;
                    inputsWrapper.style.display = 'block';
                } else {
                    // –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                    const errorText = await response.text();
                    let errorMessage = 'Failed to load workflow parameters';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    inputsContainer.innerHTML = `<div class="error-state">${errorMessage}</div>`;
                    inputsWrapper.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load workflow inputs:', error);
                inputsContainer.innerHTML = `<div class="error-state">Failed to load workflow parameters: ${error.message}</div>`;
                inputsWrapper.style.display = 'block';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ workflows
        async function loadWorkflows(owner, repo) {
            if (!owner || !repo) return;
            
            const workflowLoader = document.getElementById('workflow-loader');
            const workflowError = document.getElementById('workflow-error');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            if (workflowLoader) workflowLoader.style.display = 'flex';
            if (workflowError) workflowError.style.display = 'none';
            
            try {
                const workflowsResponse = await fetch(`/api/workflows?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`);
                
                if (workflowsResponse.ok) {
                    const workflowsData = await workflowsResponse.json();
                    updateSelect('workflow_id', workflowsData.workflows.map(w => ({id: w.id, name: w.name})), null);
                    initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º inputs –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ workflow
                    loadWorkflowInputs();
                    if (workflowError) workflowError.style.display = 'none';
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è workflows
                    let errorMessage = 'Failed to load workflows';
                    try {
                        const errorData = await workflowsResponse.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = `Failed to load workflows: ${workflowsResponse.status} ${workflowsResponse.statusText}`;
                    }
                    if (workflowError) {
                        workflowError.textContent = errorMessage;
                        workflowError.style.display = 'block';
                    }
                    console.error('Failed to load workflows:', errorMessage);
                }
            } catch (error) {
                console.error('Failed to load workflows:', error);
                if (workflowError) {
                    workflowError.textContent = `Error: ${error.message}`;
                    workflowError.style.display = 'block';
                }
            } finally {
                if (workflowLoader) workflowLoader.style.display = 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ branches –∏ workflows
        async function loadBranchesAndWorkflows(owner, repo) {
            if (!owner || !repo) return;
            
            const branchLoader = document.getElementById('branch-loader');
            const workflowLoader = document.getElementById('workflow-loader');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
            if (branchLoader) branchLoader.style.display = 'flex';
            if (workflowLoader) workflowLoader.style.display = 'flex';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
            const branchError = document.getElementById('branch-error');
            const workflowError = document.getElementById('workflow-error');
            if (branchError) branchError.style.display = 'none';
            if (workflowError) workflowError.style.display = 'none';
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è branches (–±–µ–∑ env –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
                const branchesUrl = `/api/branches?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`;
                
                const [branchesResponse, workflowsResponse] = await Promise.all([
                    fetch(branchesUrl),
                    fetch(`/api/workflows?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`)
                ]);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ branches
                if (branchesResponse.ok) {
                    const branchesData = await branchesResponse.json();
                    updateSelect('ref', branchesData.branches, 'main');
                    initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
                    if (branchError) branchError.style.display = 'none';
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è branches
                    let errorMessage = 'Failed to load branches';
                    try {
                        const errorData = await branchesResponse.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = `Failed to load branches: ${branchesResponse.status} ${branchesResponse.statusText}`;
                    }
                    if (branchError) {
                        branchError.textContent = errorMessage;
                        branchError.style.display = 'block';
                    }
                    console.error('Failed to load branches:', errorMessage);
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ workflows - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ branch —É–∂–µ –≤—ã–±—Ä–∞–Ω
                // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∑–∏–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ branch
                const refSelect = document.getElementById('ref');
                if (refSelect && refSelect.value) {
                    if (workflowsResponse.ok) {
                        const workflowsData = await workflowsResponse.json();
                        updateSelect('workflow_id', workflowsData.workflows.map(w => ({id: w.id, name: w.name})), null);
                        initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º inputs –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ workflow
                        loadWorkflowInputs();
                        if (workflowError) workflowError.style.display = 'none';
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è workflows
                        let errorMessage = 'Failed to load workflows';
                        try {
                            const errorData = await workflowsResponse.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (e) {
                            errorMessage = `Failed to load workflows: ${workflowsResponse.status} ${workflowsResponse.statusText}`;
                        }
                        if (workflowError) {
                            workflowError.textContent = errorMessage;
                            workflowError.style.display = 'block';
                        }
                        console.error('Failed to load workflows:', errorMessage);
                    }
                }
            } catch (error) {
                console.error('Failed to load branches/workflows:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É
                if (branchError) {
                    branchError.textContent = `Error: ${error.message}`;
                    branchError.style.display = 'block';
                }
                if (workflowError) {
                    workflowError.textContent = `Error: ${error.message}`;
                    workflowError.style.display = 'block';
                }
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
                if (branchLoader) branchLoader.style.display = 'none';
                if (workflowLoader) workflowLoader.style.display = 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è select
        function updateSelect(selectId, items, defaultValue) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '';
            
            items.forEach(function(item) {
                const option = document.createElement('option');
                if (typeof item === 'string') {
                    option.value = item;
                    option.textContent = item;
                } else {
                    option.value = item.id;
                    option.textContent = `${item.id} - ${item.name}`;
                    option.setAttribute('data-name', item.name);
                }
                if ((defaultValue && item === defaultValue) || (defaultValue && item.id === defaultValue) || (currentValue && (item === currentValue || item.id === currentValue))) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            if (!select.value && items.length > 0) {
                if (defaultValue) {
                    const defaultOption = Array.from(select.options).find(opt => opt.value === defaultValue);
                    if (defaultOption) {
                        defaultOption.selected = true;
                    } else if (select.options.length > 0) {
                        select.options[0].selected = true;
                    }
                } else if (select.options.length > 0) {
                    select.options[0].selected = true;
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—è Repository (owner/repo)
        function setupRepositoryField() {
            const repositoryInput = document.getElementById('repository');
            const ownerInput = document.getElementById('owner');
            const repoInput = document.getElementById('repo');
            
            if (!repositoryInput || !ownerInput || !repoInput) return;
            
            let loadTimeout;
            
            function updateOwnerRepo() {
                const value = repositoryInput.value.trim();
                const parts = value.split('/');
                
                if (parts.length >= 2) {
                    const owner = parts[0].trim();
                    const repo = parts.slice(1).join('/').trim(); // –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ repo —Å–æ–¥–µ—Ä–∂–∏—Ç /
                    ownerInput.value = owner;
                    repoInput.value = repo;
                    
                    clearTimeout(loadTimeout);
                    loadTimeout = setTimeout(function() {
                        if (owner && repo) {
                            loadBranchesAndWorkflows(owner, repo);
                        }
                    }, 500);
                }
            }
            
            repositoryInput.addEventListener('input', updateOwnerRepo);
            repositoryInput.addEventListener('blur', updateOwnerRepo);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            if (ownerInput.value && repoInput.value) {
                repositoryInput.value = `${ownerInput.value}/${repoInput.value}`;
                if (ownerInput.value && repoInput.value) {
                    loadBranchesAndWorkflows(ownerInput.value, repoInput.value);
                }
            }
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        function setupFormValidation() {
            const form = document.getElementById('workflowForm');
            if (!form) return;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø–æ Enter –≤–æ –≤—Å–µ—Ö –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
            form.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    // –†–∞–∑—Ä–µ—à–∞–µ–º Enter —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–Ω–æ–ø–∫–µ submit
                    if (e.target.tagName === 'BUTTON' && e.target.type === 'submit') {
                        return true; // –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
                    }
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º Enter –≤–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });
            
            form.addEventListener('submit', function(e) {
                const repositoryInput = document.getElementById('repository');
                const ownerInput = document.getElementById('owner');
                const repoInput = document.getElementById('repo');
                
                if (!repositoryInput || !ownerInput || !repoInput) {
                    e.preventDefault();
                    alert('Please enter a valid repository (owner/repo)');
                    return false;
                }
                
                const value = repositoryInput.value.trim();
                const parts = value.split('/');
                
                if (parts.length < 2 || !parts[0].trim() || !parts.slice(1).join('/').trim()) {
                    e.preventDefault();
                    alert('Please enter a valid repository in format: owner/repo');
                    return false;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º hidden –ø–æ–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                const owner = parts[0].trim();
                const repo = parts.slice(1).join('/').trim();
                ownerInput.value = owner;
                repoInput.value = repo;
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–ø—É—Å–∫
        function setupCopyRunButton() {
            const copyBtn = document.getElementById('copy-run-btn');
            if (!copyBtn) {
                console.warn('Copy run button not found');
                return;
            }
            
            copyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const ownerInput = document.getElementById('owner');
                const repoInput = document.getElementById('repo');
                const workflowIdSelect = document.getElementById('workflow_id');
                const refSelect = document.getElementById('ref');
                
                console.log('Copy button clicked', { ownerInput, repoInput, workflowIdSelect, refSelect });
                
                if (!ownerInput || !repoInput || !workflowIdSelect || !refSelect) {
                    alert('Please fill in repository, workflow and branch');
                    return;
                }
                
                const owner = ownerInput.value.trim();
                const repo = repoInput.value.trim();
                const workflowId = workflowIdSelect.value.trim();
                const ref = refSelect.value.trim();
                
                console.log('Values:', { owner, repo, workflowId, ref });
                
                if (!owner || !repo || !workflowId || !ref) {
                    alert('Please fill in repository, workflow and branch');
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è trigger
                const baseUrl = window.location.origin;
                const params = new URLSearchParams({
                    owner: owner,
                    repo: repo,
                    workflow_id: workflowId,
                    ref: ref
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ inputs –∏–∑ —Ñ–æ—Ä–º—ã
                const form = document.getElementById('workflowForm');
                if (form) {
                    const formData = new FormData(form);
                    for (const [key, value] of formData.entries()) {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è
                        if (!['owner', 'repo', 'workflow_id', 'ref'].includes(key) && value) {
                            params.append(key, value);
                        }
                    }
                }
                
                const triggerUrl = `${baseUrl}/workflow/trigger?${params.toString()}`;
                
                console.log('Generated URL:', triggerUrl);
                
                // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(triggerUrl).then(function() {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    const originalText = copyBtn.textContent;
                    const originalOpacity = copyBtn.style.opacity;
                    copyBtn.textContent = 'Copied!';
                    copyBtn.style.background = '#10b981';
                    copyBtn.style.color = '#fff';
                    copyBtn.style.opacity = '1';
                    copyBtn.style.borderColor = '#10b981';
                    
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '#f9fafb';
                        copyBtn.style.color = '#6b7280';
                        copyBtn.style.opacity = originalOpacity || '0.6';
                        copyBtn.style.borderColor = '#d1d5db';
                    }, 2000);
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                        // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º URL –≤ prompt
                        prompt('Copy this URL:', triggerUrl);
                    });
                } else {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    const textArea = document.createElement('textarea');
                    textArea.value = triggerUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        const originalText = copyBtn.textContent;
                        const originalOpacity = copyBtn.style.opacity;
                        copyBtn.textContent = 'Copied!';
                        copyBtn.style.background = '#10b981';
                        copyBtn.style.color = '#fff';
                        copyBtn.style.opacity = '1';
                        copyBtn.style.borderColor = '#10b981';
                        
                        setTimeout(function() {
                            copyBtn.textContent = originalText;
                            copyBtn.style.background = '#f9fafb';
                            copyBtn.style.color = '#6b7280';
                            copyBtn.style.opacity = originalOpacity || '0.6';
                            copyBtn.style.borderColor = '#d1d5db';
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        prompt('Copy this URL:', triggerUrl);
                    }
                    document.body.removeChild(textArea);
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initAll() {
            initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
            initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
            setupRepositoryField();
            setupFormValidation();
            setupCopyRunButton();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAll);
        } else {
            initAll();
        }
    </script>
</body>
</html>
